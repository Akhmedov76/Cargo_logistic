<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Driver Tracking</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAVITjz2yg1lvV2cCH5Rfob2QYQJKWTvnY"></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    let map;
    let marker;
    const driverId = 5;  // haydovchi ID (mos keltiring)

    function initMap() {
        // Dastlabki location
        const initialPosition = {lat: 41.311081, lng: 69.240562}; // Toshkent

        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: initialPosition,
        });

        marker = new google.maps.Marker({
            position: initialPosition,
            map: map,
            title: "Driver Location",
        });

        connectWebSocket();
    }

    function connectWebSocket() {
        const socket = new WebSocket(`ws://127.0.0.1:8000/ws/gps/${driverId}/`);

        socket.onopen = function (e) {
            console.log("Connected to GPS WebSocket!");
        };

        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            console.log("New location:", data.latitude, data.longitude);

            const newPosition = {
                lat: parseFloat(data.latitude),
                lng: parseFloat(data.longitude)
            };

            // Marker pozitsiyasini yangilash
            marker.setPosition(newPosition);

            // Xarita markazini markerga olib kelish
            map.setCenter(newPosition);
        };

        socket.onclose = function (e) {
            console.log("WebSocket closed.");
        };
    }

    window.onload = initMap;
</script>
</body>
</html>
